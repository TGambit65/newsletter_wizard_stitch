# PRD 4.6 — Team Management

**Phase:** 4 — Growth and Engagement
**Type:** NEW
**Complexity:** High
**Dependencies:** Task 1.2 (Dialog), Task 1.8 (Type system cleanup)

---

## Goal

Enable collaborative newsletter creation by allowing account owners to invite team members with appropriate access levels.

---

## Target User

Business/Pro tier account owner managing a content team of 2–10 people.

---

## Success Metrics

- Team feature adoption > 20% of Pro/Business accounts
- Average team size > 3 members within 60 days of onboarding
- Multi-author newsletters > 15% of total output for team accounts

---

## Features

### 1. Team Overview
Member list table showing:
- Full name and email
- Role badge (Owner, Admin, Editor, Viewer)
- Last active date
- Account status (Active, Pending, Deactivated)

### 2. Permissions Matrix

| Permission | Owner | Admin | Editor | Viewer |
|-----------|:-----:|:-----:|:------:|:------:|
| Manage team | ✓ | ✓ | ✗ | ✗ |
| Manage billing | ✓ | ✗ | ✗ | ✗ |
| Edit newsletters | ✓ | ✓ | ✓ | ✗ |
| Manage sources | ✓ | ✓ | ✓ | ✗ |
| View analytics | ✓ | ✓ | ✓ | ✓ |
| Manage API keys | ✓ | ✓ | ✗ | ✗ |
| Manage voice profiles | ✓ | ✓ | ✓ | ✗ |

### 3. Invitation Flow
- **Single invite**: Email + role selector
- **Shareable link**: Generate a tokenized invite link with a specific role
- **Bulk CSV**: Upload CSV of `email,role` pairs
- Invitations expire after 7 days
- Pending invitations show in team overview with Resend/Revoke actions

### 4. Shared Assets
Team-visible resources:
- Shared voice profiles (Owner/Admin can mark as shared)
- Shared knowledge sources
- Shared template library

---

## Data Model

```sql
CREATE TABLE team_invitations (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  tenant_id UUID REFERENCES tenants(id) ON DELETE CASCADE,
  email TEXT NOT NULL,
  role TEXT NOT NULL DEFAULT 'member',
  invited_by UUID REFERENCES profiles(id),
  token TEXT UNIQUE NOT NULL,
  status TEXT DEFAULT 'pending',  -- pending | accepted | revoked | expired
  created_at TIMESTAMPTZ DEFAULT now(),
  expires_at TIMESTAMPTZ DEFAULT (now() + INTERVAL '7 days')
);

ALTER TABLE profiles ADD COLUMN last_active_at TIMESTAMPTZ;
```

---

## Edge Functions

### `manage-team`
Operations: `invite | revoke | change-role | deactivate | list`

### `accept-invitation`
Validates token, links profile to tenant with specified role.

---

## `usePermissions` Hook

```ts
const { can } = usePermissions();
if (can('manage:team')) { /* show invite button */ }
if (can('manage:billing')) { /* show billing tab */ }
```

Permission check applied at component level — hide UI elements user cannot access.

---

## Out of Scope

- Real-time collaboration (Google Docs style concurrent editing)
- Team activity feed / audit log visible to all members
- Per-newsletter permissions (only role-level granularity in v1)

---

## Implementation Subtasks

- [ ] 4.6.1: Create DB migration: `team_invitations` table, `last_active_at` on profiles
- [ ] 4.6.2: Define permission constants in `packages/shared`: `ROLE_PERMISSIONS` mapping
- [ ] 4.6.3: Add shared types: `TeamInvitation`, `Permission`, `RolePermissions`
- [ ] 4.6.4: Create edge function `manage-team` (invite, revoke, change-role, deactivate, list)
- [ ] 4.6.5: Create edge function `accept-invitation`
- [ ] 4.6.6: Create `pages/TeamPage.tsx` with member table and pending invitations section
- [ ] 4.6.7: Build invite modal with single/link/CSV variants
- [ ] 4.6.8: Build permissions display — read-only matrix showing what each role can do
- [ ] 4.6.9: Create `hooks/usePermissions.ts`
- [ ] 4.6.10: Apply permission gating to existing pages (billing tab, Settings sections)
- [ ] 4.6.11: Add route `/team` in App.tsx, add to sidebar (Owner/Admin only)
- [ ] 4.6.12: Add `api.ts` wrappers: `inviteTeamMember()`, `revokeInvitation()`, `changeRole()`, `getTeamMembers()`
- [ ] 4.6.13: Update `last_active_at` on profile via auth middleware or periodic heartbeat

---

## Stitch Design References

`team_management:_overview`, `team_management:_permissions`, `team_management:_invitations`, `invite_new_member_v1-v4`
