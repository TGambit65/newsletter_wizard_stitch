# PRD 3.7 — Scheduling: Calendar and AI Optimization

**Phase:** 3 — Core Product Features
**Type:** EXPAND
**Complexity:** High
**Dependencies:** Task 2.1 (Real data), Task 1.2 (Dialog)

---

## Goal

Help authors schedule newsletters at optimal times with a visual planning interface that prevents scheduling conflicts.

---

## Target User

Active newsletter author sending 2+ newsletters per month who wants to plan their content calendar.

---

## Success Metrics

- 50%+ of sends are scheduled (vs immediate send)
- Measurable engagement improvement for AI-optimized send times vs manually chosen times
- Zero double-sends (conflict detection working)

---

## Features

### 1. Calendar View
- Month/week toggle
- Newsletters as colored blocks on their scheduled dates
- Click a date to open the schedule dialog
- Color-coded by status: draft (gray), scheduled (blue), sent (green)

### 2. Visual Timeline
- Horizontal scrollable queue of upcoming sends
- Newsletter cards with title, scheduled time, status
- Drag-to-reschedule (v2 stretch goal)

### 3. AI Send Time Optimization
"Suggest best time" button:
- Analyzes past engagement data by day and hour
- Highlights optimal calendar slots with confidence scores
- Shows reasoning ("Your Monday sends get 23% higher opens")

### 4. Focused Task View
Single-newsletter scheduling with:
- Date/time picker
- Timezone selector (IANA timezone names)
- Recurrence rules (weekly, biweekly, monthly)
- Recurrence end date

### 5. Smart Queue
- Priority-ordered send list
- Conflict detection — warns when scheduling within 1 hour of another send
- "Move to queue" action from editor

---

## Data Model Changes

```sql
ALTER TABLE newsletters ADD COLUMN timezone TEXT DEFAULT 'UTC';
ALTER TABLE newsletters ADD COLUMN recurrence_rule TEXT;
ALTER TABLE newsletters ADD COLUMN recurrence_end_date TIMESTAMPTZ;
```

---

## Edge Function: `suggest-send-time`

**Input:** `{ tenant_id }`
**Output:**
```json
{
  "recommended_slots": [
    { "day": "Tuesday", "hour": 9, "confidence": 0.87, "reason": "Highest open rate in past 90 days" },
    { "day": "Thursday", "hour": 10, "confidence": 0.74, "reason": "Second highest engagement" }
  ]
}
```

Analyzes `newsletter_stats` open rates grouped by day of week and hour of day.

---

## Out of Scope

- Drag-to-reschedule in calendar (v2)
- Recurring newsletter auto-generation (auto-create draft on recurrence date)
- Integration with external calendars (Google Calendar, Outlook)

---

## Implementation Subtasks

- [ ] 3.7.1: Create DB migration: add `timezone`, `recurrence_rule`, `recurrence_end_date` columns to `newsletters`
- [ ] 3.7.2: Add shared types: `SchedulingConfig`, `RecurrenceRule` in `packages/shared`
- [ ] 3.7.3: Create `pages/SchedulingPage.tsx` with calendar and timeline views
- [ ] 3.7.4: Build month calendar view component using CSS grid (no heavy calendar library)
- [ ] 3.7.5: Build week view variant with time slots
- [ ] 3.7.6: Build visual timeline component — horizontal scroll of upcoming sends
- [ ] 3.7.7: Create edge function `suggest-send-time` (spec above)
- [ ] 3.7.8: Build AI send time UI — highlighted calendar slots with confidence indicators
- [ ] 3.7.9: Update schedule modal in editor with timezone dropdown and recurrence selector
- [ ] 3.7.10: Build conflict detection — warn when scheduling < 1 hour from another send
- [ ] 3.7.11: Add `api.ts` wrappers: `suggestSendTime()`, `getScheduledNewsletters()`
- [ ] 3.7.12: Add route `/scheduling` in App.tsx, add to sidebar navigation
- [ ] 3.7.13: Mobile responsive — calendar collapses to list view on small screens

---

## Stitch Design References

`scheduling:_ai_optimized_v1`, `scheduling:_calendar_view_v2`, `scheduling:_visual_timeline_v3_*`, `scheduling:_focused_task_v4`
