# PRD 5.3 — Account Lifecycle

**Phase:** 5 — Platform and Polish
**Type:** EXPAND
**Complexity:** High
**Dependencies:** Task 0.5 (Reset password route), Task 1.2 (Dialog)

---

## Goal

Support the full account lifecycle: passwordless login, account deletion with data export, and reactivation for returning users.

---

## Target Users

- **5.3a Delete**: User leaving the platform — give them data portability and a clean exit
- **5.3b Reactivate**: Former user returning — restore context quickly
- **5.3c Magic Link**: User who prefers passwordless auth
- **5.3d Biometric**: Power user on a supported device (stretch goal)

---

## Data Model

```sql
ALTER TABLE profiles ADD COLUMN is_deactivated BOOLEAN DEFAULT false;
ALTER TABLE profiles ADD COLUMN deactivated_at TIMESTAMPTZ;

CREATE TABLE exit_surveys (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES profiles(id),
  reason TEXT NOT NULL,
  comment TEXT,
  created_at TIMESTAMPTZ DEFAULT now()
);
```

---

## Feature 5.3a: Delete Account Flow

4-step wizard at `/settings/delete-account`:

1. **Export Data** — "Download all your data" button (newsletters, sources, analytics as ZIP)
2. **Exit Survey** — Multiple choice reason + optional freeform comment
3. **Confirm** — Type "DELETE" to proceed
4. **Goodbye** — Processing screen → success → redirect to marketing landing page

**Soft delete:** Sets `is_deactivated = true`, `deactivated_at = now()`. Does not immediately remove data. Hard delete after 30-day grace period.

### Edge Functions
- `export-user-data`: Gathers all tenant data, returns downloadable JSON/ZIP
- `delete-account`: Stores exit survey, soft-deletes profile and tenant

---

## Feature 5.3b: Reactivate Account Flow

Triggered when deactivated user successfully authenticates:

1. **Welcome back** — Account summary (newsletters, sources, last active date)
2. **Plan selection** — Pick subscription tier to reactivate with
3. **Email verification** — Confirm identity
4. **Context restoration** — Show recent drafts and sources, "Resume where you left off" CTA

### Edge Function
- `reactivate-account`: Unsets `is_deactivated`, restores data, updates subscription

---

## Feature 5.3c: Magic Link Login

Passwordless email authentication:

1. "Sign in with email link" button on LoginPage
2. Calls `supabase.auth.signInWithOtp({ email })`
3. User receives email with one-click login link
4. Link opens app, `AuthCallbackPage` handles OTP callback
5. Success state: "Check your email for a sign-in link"

---

## Feature 5.3d: Biometric Login (Stretch Goal)

WebAuthn/FIDO2 fingerprint or face ID authentication:

1. "Set up biometric login" option in Settings → Security
2. Register credential via `navigator.credentials.create()`
3. Login via `navigator.credentials.get()` on supported devices
4. Graceful fallback to email/password if not supported

---

## Out of Scope

- Account merging (multiple auth providers → one account)
- GDPR data subject requests (handled via export + delete flow)
- Admin-side account management (separate admin panel)

---

## Implementation Subtasks

### 5.3a: Delete Account
- [ ] 5.3a.1: Create `pages/DeleteAccountPage.tsx` with 4-step wizard
- [ ] 5.3a.2: Create edge function `export-user-data`
- [ ] 5.3a.3: Create edge function `delete-account` with exit survey storage and soft-delete
- [ ] 5.3a.4: Create DB migration: `exit_surveys` table, profile deactivation columns
- [ ] 5.3a.5: Add route `/settings/delete-account` or Settings sub-section

### 5.3b: Reactivate Account
- [ ] 5.3b.1: Create `pages/ReactivatePage.tsx` with welcome back flow
- [ ] 5.3b.2: Modify auth flow: detect deactivated profile → redirect to `/reactivate`
- [ ] 5.3b.3: Create edge function `reactivate-account`

### 5.3c: Magic Link
- [ ] 5.3c.1: Add "Sign in with email link" button to LoginPage
- [ ] 5.3c.2: Call `supabase.auth.signInWithOtp({ email })` for passwordless flow
- [ ] 5.3c.3: Extend `AuthCallbackPage` to handle OTP callback (currently handles OAuth only)
- [ ] 5.3c.4: Add success state: "Check your email for a sign-in link"

### 5.3d: Biometric (Stretch)
- [ ] 5.3d.1: Research WebAuthn/FIDO2 integration with Supabase Auth
- [ ] 5.3d.2: Add "Set up biometric login" in Settings → Security
- [ ] 5.3d.3: Register credential via `navigator.credentials.create()`
- [ ] 5.3d.4: Login via `navigator.credentials.get()` with fallback to email/password

---

## Stitch Design References

`delete_account:_*`, `reactivate:_*`, `login:_magic_link_v3`, `login:_biometric_entry_v2`
